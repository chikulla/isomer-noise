<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>untitled</title>
  <!--<script src="node_modules/isomer/dist/isomer.min.js"></script>-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/isomer/0.2.6/isomer.min.js"></script>
  <style>
    body {
      margin: 0;
    }

    canvas {
      width: 100%;
    }
  </style>
</head>
<body>
<canvas height="1000" width="1000" id="art"></canvas>
</div>
<script>
  function indexies() {
    const len = 3; // default length of side 23
    return Array(len).fill(0).map((v, i) => i - (len / 4)).reverse();
  }

  function randomInt(num) {
    return Math.floor(Math.random() * num);
  }

  class Range {
    constructor(min, max) {
      this.min = min;
      this.max = max;
    }
  }

  class RandomColor {
    constructor(rRange, gRange, bRange) {
      this.r = rRange;
      this.g = gRange;
      this.b = bRange;
    }

    random() {
      return new Isomer.Color(
        randomInt(this.r.max - this.r.min) + this.r.min,
        randomInt(this.g.max - this.g.min) + this.g.min,
        randomInt(this.b.max - this.b.min) + this.b.min
      )
    }
  }

  class RandomGen {
    constructor(color, maxInterval, maxHeight) {
      this.color = color;
      this.maxInterval = maxInterval;
      this.maxHeight = maxHeight;
    }

    randomColor() {
      return this.color.random();
    }

    randomHeight() {
      return Math.random() * this.maxHeight;
    }

    randomInterval() {
      return randomInt(this.maxInterval);
    }

    random(num) {
      return Math.floor(Math.random() * num);
    }
  }

  class DefaultRandomGenFactory {
    generateRange(min, max) {
      return {min, max};
    }

    generateColor() {
      return new RandomColor(
        this.generateRange(0, 255),
        this.generateRange(0, 255),
        this.generateRange(0, 255)
      );
    }

    generate() {
      return new RandomGen(this.generateColor(), 100, 1);
    }
  }

  class RandomDot {
    constructor(x, y) {
      this.x = x;
      this.y = y;
      this.r = new DefaultRandomGenFactory().generate();
      this.before = this.randomColorHeight();
      this.after = this.randomColorHeight();
      this.resetInterval();
    }

    updateSeed(randomGen) {
      this.r = randomGen;
    }

    resetInterval() {
      this.interval = this.randomInterval();
      this.progress = 0;
    }

    randomColor() {
      return this.r.randomColor()
    }

    random(num) {
      return Math.floor(Math.random() * num);
    }

    randomHeight() {
      return this.r.randomHeight();
    }


    randomColorHeight() {
      return {
        color: this.randomColor(),
        height: this.randomHeight()
      };
    }

    randomInterval() {
      return this.r.randomInterval();
    }

    update() {
      this.progress++;
      if (this.progress >= this.interval) {
        this.before = this.after;
        this.after = this.randomColorHeight();
        this.resetInterval()
      }
    }

    currentColor() {
      return new Isomer.Color(
        this.currentValue(this.before.color.r, this.after.color.r),
        this.currentValue(this.before.color.g, this.after.color.g),
        this.currentValue(this.before.color.b, this.after.color.b),
        this.currentValue(this.before.color.a, this.after.color.a),
      );
    }

    currentHeight() {
      return this.currentValue(this.before.height, this.after.height);
    }

    currentValue(before, after) {
      const r = (after - before) / this.interval * this.progress + before;
      return r;
    }

    current() {
      this.update();
      return {
        x: this.x,
        y: this.y,
        color: this.currentColor(),
        height: this.currentHeight()
      };
    }

  }

  function renderDot(iso, d) {
    iso.add(
      Isomer.Shape.Prism(
        Isomer.Point(d.x, d.y, 0),
        1,
        1,
        d.height
      ),
      d.color
    );
  }

  function main() {
    const canvas = document.getElementById('art');
    const ctx = canvas.getContext('2d');
    const iso = new Isomer(canvas);
    const xlist = indexies();
    const ylist = indexies();
    const grids = xlist
      .map((x) => ylist.map((y) => ({x, y})))
      .reduce((a, b) => a.concat(b));

    const dots = grids.map((g) => new RandomDot(g.x, g.y));

    function loop() {
      requestAnimationFrame(loop);

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      dots.map((d) => d.current()).forEach((d) => {
        renderDot(iso, d);
      });
    }

    requestAnimationFrame(loop);
  }

  main();
</script>
</body>
</html>